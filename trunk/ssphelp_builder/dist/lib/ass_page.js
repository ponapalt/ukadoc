// Generated by CoffeeScript 1.8.0
var query_field, results_field, segmenter;

query_field = $('#query');

results_field = $('#results');

query_field.attr('disabled', true);

results_field.text('準備中...');

segmenter = new TinySegmenter();

$.ajax({
  url: 'assdb.json',
  dataType: 'json',
  error: function(xhr, status, error) {
    return console.warn('error');
  },
  success: function(db) {
    AllSiteSearch.load(db);
    query_field.keypress(function() {
      var contents, query_element, query_elements, query_token, query_tokens, section, sections, _i, _j, _k, _len, _len1, _len2, _results;
      results_field.html('');
      query_elements = query_field.val().split(/\s+/);
      query_tokens = [];
      for (_i = 0, _len = query_elements.length; _i < _len; _i++) {
        query_element = query_elements[_i];
        query_tokens = query_tokens.concat(segmenter.segment(query_element));
      }
      sections = AllSiteSearch.search_sections(query_elements);
      _results = [];
      for (_j = 0, _len1 = sections.length; _j < _len1; _j++) {
        section = sections[_j];
        contents = section.contents;
        for (_k = 0, _len2 = query_tokens.length; _k < _len2; _k++) {
          query_token = query_tokens[_k];
          contents = contents.replace(new RegExp(query_token, 'gi'), '<span style="background:#ff0">' + query_token + '</span>');
        }
        _results.push(results_field.append("<dt><a href=\"" + section.id + "\">" + section.title + "</a></dt>\n<dd>" + contents + "</d>>"));
      }
      return _results;
    });
    query_field.removeAttr('disabled');
    results_field.text('ready');
    return query_field.keypress();
  }
});
